<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Study Board — 投稿一覧</title>

<link rel="stylesheet" href="assets/style.css">
<script src="assets/theme.js" defer></script>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

</head>
<body>
<div class="container">
  <div class="card search-row">
    <input id="search-input" placeholder="キーワード、タグ、投稿者で検索（例: #数学、山田）" />
    <button id="search-btn">検索</button>
  </div>

  <div class="card" style="margin-top:12px">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div style="font-weight:700">おすすめタグ</div>
      <div style="display:flex;gap:8px">
        <button id="filter-grade" class="btn" style="background:transparent;color:var(--accent);border:1px solid var(--border)">学年で絞る</button>
      </div>
    </div>
    <div id="recommended-tags" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px"></div>
  </div>

  <div class="card" style="margin-top:12px">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div style="font-weight:700">投稿一覧</div>
      <div class="muted" id="posts-count"></div>
    </div>
    <div id="posts" class="posts-grid" style="margin-top:12px"></div>
  </div>
</div>

<button class="fab" id="open-new">＋</button>

<!-- New post modal -->
<div id="modal-new" class="modal-overlay">
  <div class="modal card">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div style="font-weight:700">新しい投稿</div>
      <button id="close-new" class="icon-btn">✕</button>
    </div>
    <div style="margin-top:12px">
      <div class="form-row">
        <input id="post-title" placeholder="タイトル（任意）" />
        <select id="post-subject" style="width:180px">
          <option>数学</option><option>国語</option><option>理科</option><option>社会</option><option>英語</option><option>その他</option>
        </select>
      </div>
      <textarea id="post-body" placeholder="本文（Markdown可）"></textarea>
      <div class="form-row" style="margin-top:8px">
        <input id="post-hashtags" placeholder="#タグはスペースで区切る（例: #数学 #三角形）" />
        <select id="post-audience" style="width:220px">
          <option value="">公開：全員</option>
          <option value="中1">一年生のみ</option>
          <option value="中2">二年生のみ</option>
          <option value="中3">三年生のみ</option>
          <option value="teacher">先生のみ</option>
        </select>
      </div>
      <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
        <label style="font-size:.9rem;color:var(--muted)">添付画像 (任意)</label>
        <input id="post-image" type="file" accept="image/*" />
      </div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
        <button id="submit-post" class="btn">投稿する</button>
        <button id="cancel-post" class="btn" style="background:transparent;color:var(--accent);border:1px solid var(--border)">閉じる</button>
      </div>

      <details style="margin-top:12px">
        <summary style="cursor:pointer;font-weight:600">タグのおすすめ・人気タグ</summary>
        <div id="recommended-tags-list" style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap"></div>
        <div id="popular-tags-list" style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap"></div>
      </details>
    </div>
  </div>
</div>

<div id="toast"></div>
<div id="loading-overlay" style="display:none"><div class="spinner card">読み込み中…</div></div>

<script>
/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyBfstQdl-avHfBWaiPkC0Bzwm_9apWe6Mo",
  authDomain: "school-board-e2ee2.firebaseapp.com",
  projectId: "school-board-e2ee2",
  storageBucket: "school-board-e2ee2.appspot.com",
  messagingSenderId: "257360614407",
  appId: "1:257360614407:web:7cdae33b9ac7d7a671c6a2"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

let currentUser = null;
let postsCache = [];
let fuse = null;
const recommendedDefault = ['#数学','#国語','#理科','#社会','#英語','#テスト対策'];

/* helpers */
const $ = s => document.querySelector(s);
function showToast(msg){ window.showToast ? window.showToast(msg) : alert(msg); }
function showLoading(on=true){ window.showLoading ? window.showLoading(on) : $('#loading-overlay').style.display = on ? 'flex' : 'none'; }
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function formatDate(ts){ if(!ts) return ''; try{return new Date(ts.seconds*1000).toLocaleString(); }catch(e){ return ''; } }

/* init */
document.addEventListener('DOMContentLoaded', ()=>{
  setupUI();
  auth.onAuthStateChanged(u=> currentUser = u || null);
  listenPosts();
  loadTagWidgets();
});

function setupUI(){
  $('#search-btn').addEventListener('click', ()=> applySearch($('#search-input').value.trim()));
  $('#open-new').addEventListener('click', ()=> $('#modal-new').style.display='flex');
  $('#close-new').addEventListener('click', ()=> $('#modal-new').style.display='none');
  $('#cancel-post').addEventListener('click', ()=> $('#modal-new').style.display='none');
  $('#submit-post').addEventListener('click', submitPost);
  $('#recommended-tags').addEventListener('click', e=>{
    if(e.target.classList.contains('tag')){ $('#search-input').value = e.target.textContent; applySearch(e.target.textContent); }
  });
}

function listenPosts(){
  showLoading(true);
  db.collection('posts').orderBy('createdAt','desc').onSnapshot(snap=>{
    postsCache = snap.docs.map(d=>({ id:d.id, ...(d.data()||{}) }));
    fuse = new Fuse(postsCache, { keys:['title','content','hashtags','userName'], threshold:0.36 });
    renderPosts(postsCache);
    showLoading(false);
  }, err=>{ console.error(err); showLoading(false); });
}

function renderPosts(list){
  const el = $('#posts'); el.innerHTML = '';
  $('#posts-count').textContent = `全 ${list.length} 件`;
  list.forEach(p=>{
    const node = document.createElement('article'); node.className='post-card card fade-in';
    const title = escapeHtml(p.title||'').slice(0,140) || '(タイトルなし)';
    const excerpt = escapeHtml((p.content||'').replace(/\n/g,' ').slice(0,260));
    const tagsHTML = (p.hashtags||[]).map(h=>`<span class="tag">${escapeHtml(h)}</span>`).join(' ');
    node.innerHTML = `
      <div class="post-meta"><div>${escapeHtml(p.userName || '匿名')}</div><div style="margin-left:auto">${formatDate(p.createdAt)} ・ ${escapeHtml(p.userGrade||'')}</div></div>
      <div class="post-title">${title}</div>
      <div class="post-excerpt">${excerpt}${(p.content||'').length>260?'…':''}</div>
      <div class="tags">${tagsHTML}</div>
      <div class="actions">
        <button class="icon-btn like-btn" data-id="${p.id}">👍 <span class="count">${p.goodCount||0}</span></button>
        <button class="icon-btn bookmark-btn" data-id="${p.id}">⭐</button>
        <button class="icon-btn share-btn" data-id="${p.id}">🔗</button>
        <button class="icon-btn open-btn" data-id="${p.id}">🔍 詳細</button>
      </div>`;
    // events
    node.querySelector('.open-btn').addEventListener('click', ()=> location.href = `post.html?id=${p.id}`);
    node.querySelector('.share-btn').addEventListener('click', async ev=>{ ev.currentTarget.animate([{transform:'scale(1.05)'},{transform:'scale(1)'}],{duration:160}); await navigator.clipboard.writeText(`${location.origin}/post.html?id=${p.id}`); showToast('リンクをコピーしました！'); });
    const likeBtn = node.querySelector('.like-btn');
    likeBtn.addEventListener('click', ()=> handleLikePost(p.id, likeBtn));
    const bookmarkBtn = node.querySelector('.bookmark-btn');
    bookmarkBtn.addEventListener('click', ()=> handleBookmark(p.id, bookmarkBtn));
    if(currentUser && Array.isArray(p.goodUserIds) && p.goodUserIds.includes(currentUser.uid)) likeBtn.classList.add('liked');
    el.appendChild(node);
  });
}

/* like */
async function handleLikePost(postId, btn){
  if(!currentUser){ showToast('ログインが必要です'); return; }
  btn.disabled = true; btn.classList.add('like-pulse');
  setTimeout(()=> btn.classList.remove('like-pulse'), 420);
  try{
    const ref = db.collection('posts').doc(postId);
    await db.runTransaction(async tr=>{
      const s = await tr.get(ref);
      if(!s.exists) return;
      const data = s.data();
      const uids = data.goodUserIds || [];
      let cnt = data.goodCount || 0;
      if(uids.includes(currentUser.uid)){
        uids.splice(uids.indexOf(currentUser.uid),1); cnt--; tr.update(ref,{goodUserIds:uids,goodCount:cnt}); btn.classList.remove('liked');
      } else {
        uids.push(currentUser.uid); cnt++; tr.update(ref,{goodUserIds:uids,goodCount:cnt}); btn.classList.add('liked');
        if(data.userId && data.userId !== currentUser.uid) db.collection('notifications').add({ to:data.userId, text: `${currentUser.displayName||'誰か'} があなたの投稿にいいねしました`, createdAt: firebase.firestore.FieldValue.serverTimestamp(), read:false });
      }
      btn.querySelector('.count').textContent = cnt;
    });
  }catch(e){ console.error(e); showToast('操作に失敗しました'); }
  finally{ btn.disabled=false; }
}

/* bookmark */
async function handleBookmark(postId, btn){
  if(!currentUser){ showToast('ログインしてください'); return; }
  btn.disabled = true;
  try{
    const bmRef = db.collection('users').doc(currentUser.uid).collection('bookmarks').doc(postId);
    const doc = await bmRef.get();
    if(doc.exists){ await bmRef.delete(); btn.classList.remove('bookmarked'); showToast('ブックマークを解除しました'); }
    else { await bmRef.set({ postId, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); btn.classList.add('bookmarked'); showToast('ブックマークに追加しました'); }
  }catch(e){ console.error(e); showToast('操作に失敗しました'); }
  finally{ btn.disabled=false; }
}

/* submit post */
async function submitPost(){
  if(!currentUser){ showToast('ログインが必要です'); return; }
  const title = $('#post-title').value.trim();
  const content = $('#post-body').value.trim();
  const hashtags = ($('#post-hashtags').value || '').split(/\s+/).filter(s=>s.startsWith('#')).slice(0,8);
  const subject = $('#post-subject').value || '';
  const audience = $('#post-audience').value || '';
  if(!content){ showToast('本文を入力してください'); return; }
  showLoading(true);
  try{
    let imageUrl = '';
    const file = $('#post-image').files[0];
    if(file){
      const ref = storage.ref().child(`posts/${currentUser.uid}/${Date.now()}_${file.name}`);
      await ref.put(file);
      imageUrl = await ref.getDownloadURL();
    }
    await db.collection('posts').add({
      userId: currentUser.uid,
      userName: currentUser.displayName || (currentUser.email||'').split('@')[0],
      userGrade: '', title, content, subject, hashtags, audience,
      goodCount:0, goodUserIds:[], replyCount:0, solved:false, imageUrl:imageUrl||'',
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    showToast('投稿しました！');
    $('#post-title').value=''; $('#post-body').value=''; $('#post-hashtags').value=''; $('#post-image').value='';
    $('#modal-new').style.display='none';
  }catch(e){ console.error(e); showToast('投稿に失敗しました'); }
  finally{ showLoading(false); }
}

/* search */
function applySearch(query){
  if(!query){ renderPosts(postsCache); return; }
  if(!fuse){ renderPosts(postsCache); return; }
  const res = fuse.search(query);
  const items = res.map(r => r.item);
  renderPosts(items);
}

/* tags */
async function loadTagWidgets(){
  const snaps = await db.collection('posts').get();
  const counts = {};
  snaps.forEach(d => (d.data().hashtags||[]).forEach(h=> counts[h] = (counts[h]||0)+1));
  const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,6).map(x=>x[0]);
  $('#popular-tags-list').innerHTML = sorted.map(t=>`<button class="tag">${t}</button>`).join('');
  $('#recommended-tags-list').innerHTML = recommendedDefault.map(t=>`<button class="tag">${t}</button>`).join('');
  $('#recommended-tags').innerHTML = recommendedDefault.map(t=>`<div class="tag ghost">${t}</div>`).join('');
  document.addEventListener('click', e=>{
    if(e.target.classList.contains('tag')){
      const tag = e.target.textContent.trim();
      $('#search-input').value = tag; applySearch(tag);
    }
  });
}
</script>
</body>
</html>
