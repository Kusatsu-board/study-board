<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>投稿詳細 - Study Board</title>

<link rel="stylesheet" href="assets/style.css">
<script src="assets/theme.js" defer></script>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
</head>
<body>
<div class="container">
  <div id="post-card" class="card"></div>

  <div class="card">
    <h3>返信</h3>
    <div id="reply-list"></div>

    <div style="margin-top:12px">
      <textarea id="reply-input" placeholder="返信を入力（Markdown可）"></textarea>
      <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
        <label><input type="checkbox" id="is-answer" /> 投稿に対する答え（ハイライト）</label>
        <input id="reply-image" type="file" accept="image/*" style="margin-left:auto" />
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button id="send-reply" class="btn">返信を送信</button>
      </div>
    </div>
  </div>
</div>

<div id="toast"></div>
<div id="loading-overlay" style="display:none"><div class="spinner card">読み込み中…</div></div>

<script>
/* ========== Firebase初期化 ========== */
const firebaseConfig = {
  apiKey: "AIzaSyBfstQdl-avHfBWaiPkC0Bzwm_9apWe6Mo",
  authDomain: "school-board-e2ee2.firebaseapp.com",
  projectId: "school-board-e2ee2",
  storageBucket: "school-board-e2ee2.appspot.com",
  messagingSenderId: "257360614407",
  appId: "1:257360614407:web:7cdae33b9ac7d7a671c6a2"
};
if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth(), db = firebase.firestore(), storage = firebase.storage();

const $ = s => document.querySelector(s);
const postId = new URLSearchParams(location.search).get('id');
let currentUser = null, postDoc = null;

/* ========== 共通関数 ========== */
const showToast = msg => window.showToast ? window.showToast(msg) : alert(msg);
const showLoading = on => $('#loading-overlay').style.display = on ? 'flex' : 'none';
const formatDate = ts => ts ? new Date(ts.seconds*1000).toLocaleString() : '';

/* ========== 起動時処理 ========== */
document.addEventListener('DOMContentLoaded', ()=>{
  showLoading(true);
  auth.onAuthStateChanged(u=>{
    currentUser = u || null;
    loadPost().then(startReplyListener);
  });
});

/* ========== 投稿読み込み ========== */
async function loadPost(){
  if(!postId){ $('#post-card').innerHTML='<div class="card">投稿IDがありません</div>'; return; }
  try{
    const doc = await db.collection('posts').doc(postId).get();
    if(!doc.exists){ $('#post-card').innerHTML='<div class="card">投稿が見つかりません</div>'; return; }
    postDoc = { id: doc.id, ...doc.data() };
    renderPost(postDoc);
  }catch(e){
    console.error(e);
    showToast('投稿読み込みエラー');
  }finally{ showLoading(false); }
}

function renderPost(p){
  const tags = (p.hashtags||[]).map(h=>`<span class="tag">${h}</span>`).join(' ');
  const html = DOMPurify.sanitize(marked.parse(p.content||''));
  $('#post-card').innerHTML = `
    <div style="display:flex;gap:12px;">
      <div style="flex:1">
        <div><strong>${p.userName||'匿名'}</strong> ・ ${formatDate(p.createdAt)}</div>
        <h2>${p.title||'(無題)'}</h2>
        <div class="content">${html}</div>
        <div style="margin-top:6px">${tags}</div>
        <div style="margin-top:8px">
          <button id="like-post" class="icon-btn">👍 <span id="post-like-count">${p.goodCount||0}</span></button>
          <button id="bookmark-post" class="icon-btn">⭐</button>
        </div>
      </div>
    </div>
  `;
  $('#like-post').addEventListener('click',()=>toggleLikePost(p.id));
}

/* ========== 返信読み込み（リアルタイム） ========== */
let replyUnsub = null;
function startReplyListener(){
  if(replyUnsub) replyUnsub();
  replyUnsub = db.collection('replies')
    .where('postId','==',postId)
    .orderBy('createdAt','asc')
    .onSnapshot(snap=>{
      const replies = snap.docs.map(d=>({id:d.id,...d.data()}));
      renderReplies(replies);
    }, err=>{
      console.error(err);
      showToast('返信の取得に失敗しました');
    });
}

/* ========== 返信ツリー描画 ========== */
function renderReplies(flat){
  const map = {};
  flat.forEach(r => map[r.id] = { ...r, children: [] });
  const roots = [];
  flat.forEach(r=>{
    if(r.parentId && map[r.parentId]) map[r.parentId].children.push(map[r.id]);
    else roots.push(map[r.id]);
  });
  const list = $('#reply-list');
  list.innerHTML='';
  roots.forEach(r=> list.appendChild(renderReplyNode(r)));
}

function renderReplyNode(node){
  const el = document.createElement('div');
  el.className = 'reply card';
  const html = DOMPurify.sanitize(marked.parse(node.content||''));
  el.innerHTML = `
    <div class="reply-meta"><strong>${node.userName||'匿名'}</strong> ・ ${formatDate(node.createdAt)}</div>
    <div class="reply-body">${html}</div>
    ${node.imageUrl ? `<img src="${node.imageUrl}" style="max-width:220px;border-radius:8px;margin-top:6px">` : ''}
    <div class="reply-actions">
      <button class="icon-btn like-reply">👍 <span class="count">${node.goodCount||0}</span></button>
      <button class="icon-btn reply-btn">↩ 返信</button>
      ${currentUser && currentUser.uid === node.userId ? `<button class="icon-btn del-reply" style="color:red">🗑 削除</button>` : ''}
    </div>
    <div class="reply-children"></div>
  `;

  // イベント
  el.querySelector('.like-reply').addEventListener('click',()=>toggleLikeReply(node.id,el.querySelector('.count')));
  el.querySelector('.reply-btn').addEventListener('click',()=>{
    $('#reply-input').focus();
    $('#reply-input').dataset.parent = node.id;
  });
  const del = el.querySelector('.del-reply');
  if(del) del.addEventListener('click',async()=>{
    if(confirm('削除しますか？')){
      await db.collection('replies').doc(node.id).delete();
      showToast('削除しました');
    }
  });

  const children = el.querySelector('.reply-children');
  node.children.forEach(c=>children.appendChild(renderReplyNode(c)));
  return el;
}

/* ========== 返信送信 ========== */
$('#send-reply').addEventListener('click',async()=>{
  if(!currentUser){ showToast('ログインしてください'); return; }
  const text = $('#reply-input').value.trim();
  if(!text){ showToast('本文を入力してください'); return; }

  const parentId = $('#reply-input').dataset.parent || null;
  const file = $('#reply-image').files[0];
  let imageUrl = '';
  showLoading(true);

  try{
    if(file){
      const ref = storage.ref().child(`replies/${postId}/${Date.now()}_${file.name}`);
      await ref.put(file);
      imageUrl = await ref.getDownloadURL();
    }
    await db.collection('replies').add({
      postId,
      parentId,
      content: text,
      imageUrl,
      userId: currentUser.uid,
      userName: currentUser.displayName || (currentUser.email||'').split('@')[0],
      goodCount: 0,
      goodUserIds: [],
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    $('#reply-input').value='';
    delete $('#reply-input').dataset.parent;
    $('#reply-image').value='';
    showToast('返信を送信しました');
  }catch(e){
    console.error(e);
    showToast('返信送信に失敗しました');
  }finally{
    showLoading(false);
  }
});

/* ========== 返信いいね ========== */
async function toggleLikeReply(id, counterEl){
  if(!currentUser){ showToast('ログインしてください'); return; }
  const ref = db.collection('replies').doc(id);
  await db.runTransaction(async tr=>{
    const s = await tr.get(ref);
    if(!s.exists) return;
    const d = s.data();
    let { goodUserIds=[], goodCount=0 } = d;
    if(goodUserIds.includes(currentUser.uid)){
      goodUserIds = goodUserIds.filter(x=>x!==currentUser.uid);
      goodCount--;
    }else{
      goodUserIds.push(currentUser.uid);
      goodCount++;
    }
    tr.update(ref,{goodUserIds,goodCount});
    counterEl.textContent = goodCount;
  });
}

/* ========== 投稿いいね ========== */
async function toggleLikePost(pid){
  if(!currentUser){ showToast('ログインしてください'); return; }
  const ref = db.collection('posts').doc(pid);
  await db.runTransaction(async tr=>{
    const s = await tr.get(ref);
    if(!s.exists) return;
    const d = s.data();
    let { goodUserIds=[], goodCount=0 } = d;
    if(goodUserIds.includes(currentUser.uid)){
      goodUserIds = goodUserIds.filter(x=>x!==currentUser.uid);
      goodCount--;
    }else{
      goodUserIds.push(currentUser.uid);
      goodCount++;
    }
    tr.update(ref,{goodUserIds,goodCount});
    $('#post-like-count').textContent = goodCount;
  });
}
</script>
</body>
</html>

