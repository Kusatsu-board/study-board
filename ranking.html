<!DOCTYPE html>
<html lang="ja">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>ランキング - Study Board</title>
<link rel="stylesheet" href="assets/style.css">
<script src="assets/theme.js" defer></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
<div class="container">
  <div class="card" style="display:flex;align-items:center;justify-content:space-between">
    <h2>ランキング</h2>
    <div>
      <select id="ranking-filter" style="padding:8px;border-radius:8px;border:1px solid var(--border)">
        <option value="global">総合（いいね数）</option>
        <option value="postCount">投稿数</option>
        <option value="bestAnswerCount">ベスト回答数</option>
      </select>
    </div>
  </div>

  <div style="margin-top:12px" class="card">
    <h3>上位ユーザー</h3>
    <div id="ranks" class="rank-grid" style="margin-top:12px"></div>
  </div>
</div>

<div id="toast"></div>
<div id="loading-overlay" style="display:none"><div class="spinner card">読み込み中…</div></div>

<script>
/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyBfstQdl-avHfBWaiPkC0Bzwm_9apWe6Mo",
  authDomain: "school-board-e2ee2.firebaseapp.com",
  projectId: "school-board-e2ee2",
  storageBucket: "school-board-e2ee2.appspot.com",
  messagingSenderId: "257360614407",
  appId: "1:257360614407:web:7cdae33b9ac7d7a671c6a2"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const $ = s=>document.querySelector(s);
function showToast(m){ window.showToast ? window.showToast(m) : alert(m); }
function showLoading(on=true){ window.showLoading ? window.showLoading(on) : document.getElementById('loading-overlay').style.display = on ? 'flex' : 'none'; }

document.addEventListener('DOMContentLoaded', ()=>{ loadRanking('global'); $('#ranking-filter').addEventListener('change', e=> loadRanking(e.target.value)); });

async function loadRanking(mode){
  showLoading(true);
  try{
    // users collection expected to have postCount, goodCount, bestAnswerCount
    const snaps = await db.collection('users').get();
    const arr = snaps.docs.map(d=>({ id:d.id, ...d.data() }));
    let sorted;
    if(mode === 'postCount') sorted = arr.sort((a,b)=>(b.postCount||0)-(a.postCount||0));
    else if(mode === 'bestAnswerCount') sorted = arr.sort((a,b)=>(b.bestAnswerCount||0)-(a.bestAnswerCount||0));
    else sorted = arr.sort((a,b)=>(b.goodCount||0)-(a.goodCount||0));
    renderRanking(sorted.slice(0,30));
  }catch(e){ console.error(e); showToast('ランキング取得失敗'); }
  finally{ showLoading(false); }
}

function renderRanking(list){
  const el = $('#ranks'); el.innerHTML = '';
  list.forEach((u,i)=>{
    const card=document.createElement('div'); card.className='rank-card card';
    const medal = i===0 ? '🥇' : i===1 ? '🥈' : i===2 ? '🥉' : `#${i+1}`;
    card.innerHTML = `
      <div style="display:flex;align-items:center;gap:12px">
        <div style="width:56px;height:56px;border-radius:999px;overflow:hidden;border:2px solid var(--accent)"><img src="${u.iconUrl||'https://upload.wikimedia.org/wikipedia/commons/9/99/Sample_User_Icon.png'}" style="width:100%;height:100%;object-fit:cover"></div>
        <div style="flex:1">
          <div style="display:flex;align-items:center;gap:8px">
            <div style="font-weight:700">${u.displayName||u.name||'匿名'}</div>
            <div class="muted">${u.grade||'未設定'}</div>
          </div>
          <div class="muted" style="margin-top:6px">いいね：${u.goodCount||0} ・ 投稿：${u.postCount||0} ・ ベスト：${u.bestAnswerCount||0}</div>
        </div>
        <div style="text-align:right">
          <div style="font-size:1.1rem">${medal}</div>
          <div style="font-weight:700">${i<3?['1st','2nd','3rd'][i]:i+1}</div>
        </div>
      </div>`;
    card.addEventListener('click', ()=> location.href = `profile.html?uid=${u.id}`);
    el.appendChild(card);
  });
}
</script>
</body>
</html>
