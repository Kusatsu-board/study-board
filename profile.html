<!DOCTYPE html>
<html lang="ja">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>プロフィール - Study Board</title>
<link rel="stylesheet" href="assets/style.css">
<script src="assets/theme.js" defer></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
</head>
<body>
<div class="container">
  <div class="card profile-head">
    <img id="user-icon" src="" alt="icon">
    <div style="flex:1">
      <div style="display:flex;align-items:center;gap:12px">
        <h2 id="user-name"></h2>
        <button id="heart-user" class="icon-btn">♡ <span id="user-like-count">0</span></button>
      </div>
      <div class="muted" id="user-grade"></div>
      <div style="margin-top:6px">最終ログイン：<span id="user-lastlogin"></span></div>
      <div id="badges" style="margin-top:8px"></div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <h3>自己紹介</h3>
    <div id="user-bio" style="white-space:pre-wrap"></div>
    <h4 style="margin-top:10px">好きな教科</h4>
    <div id="user-fav"></div>
    <h4 style="margin-top:10px">趣味</h4>
    <div id="user-hobby"></div>
  </div>

  <div id="owner-area" class="card" style="margin-top:12px;display:none">
    <h3>プロフィール編集</h3>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
      <label>アイコン<input type="file" id="icon-input" accept="image/*" /></label>
    </div>
    <label>自己紹介<textarea id="bio-input" style="min-height:120px"></textarea></label>
    <div style="display:flex;gap:8px;margin-top:8px">
      <input id="fav-input" placeholder="好きな教科" />
      <input id="hobby-input" placeholder="趣味" />
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button id="save-profile" class="btn">保存</button>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <h3>最近の投稿</h3>
    <div id="recent-posts"></div>
  </div>
</div>

<div id="toast"></div>
<div id="loading-overlay" style="display:none"><div class="spinner card">読み込み中…</div></div>

<script>
/* Firebase init */
const firebaseConfig = {
  apiKey: "AIzaSyBfstQdl-avHfBWaiPkC0Bzwm_9apWe6Mo",
  authDomain: "school-board-e2ee2.firebaseapp.com",
  projectId: "school-board-e2ee2",
  storageBucket: "school-board-e2ee2.appspot.com",
  messagingSenderId: "257360614407",
  appId: "1:257360614407:web:7cdae33b9ac7d7a671c6a2"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth(), db = firebase.firestore(), storage = firebase.storage();

const queryUid = new URLSearchParams(location.search).get('uid');
let currentUser = null;
let viewingUid = queryUid || null;

const $ = s => document.querySelector(s);
function showToast(m){ window.showToast ? window.showToast(m) : alert(m); }
function showLoading(on=true){ window.showLoading ? window.showLoading(on) : $('#loading-overlay').style.display = on ? 'flex' : 'none'; }
function formatDate(ts){ if(!ts) return ''; try{return new Date(ts.seconds*1000).toLocaleString()}catch(e){return''} }
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

auth.onAuthStateChanged(u=>{
  currentUser = u || null;
  if(!viewingUid && currentUser) viewingUid = currentUser.uid;
  if(!viewingUid){ alert('プロフィールを表示するユーザーが指定されていません'); location.href='index.html'; return; }
  subscribeProfile(viewingUid);
  loadRecent(viewingUid);
});

function subscribeProfile(uid){
  db.collection('users').doc(uid).onSnapshot(doc=>{
    if(!doc.exists){ showToast('ユーザーが見つかりません'); return; }
    const d = doc.data();
    renderProfile(uid,d);
  });
}

function renderProfile(uid,data){
  $('#user-icon').src = data.iconUrl || 'https://upload.wikimedia.org/wikipedia/commons/9/99/Sample_User_Icon.png';
  $('#user-name').textContent = data.displayName || data.name || '不明';
  $('#user-grade').textContent = data.grade || '未設定';
  $('#user-lastlogin').textContent = data.lastLogin ? new Date(data.lastLogin.seconds*1000).toLocaleString() : (data.lastSignIn || '不明');
  $('#user-bio').textContent = data.bio || '';
  $('#user-fav').textContent = data.fav || '';
  $('#user-hobby').textContent = data.hobby || '';
  $('#user-like-count').textContent = data.likeCount || 0;

  // badges
  const badges=[];
  if(data.postCount>=10) badges.push('投稿職人');
  if(data.goodCount>=20) badges.push('人気ユーザー');
  if(data.bestAnswerCount>=5) badges.push('知識王');
  $('#badges').innerHTML = badges.map(b=>`<span class="badge">${b}</span>`).join('');

  // owner
  if(currentUser && currentUser.uid === uid){
    $('#owner-area').style.display='block';
    $('#bio-input').value = data.bio || '';
    $('#fav-input').value = data.fav || '';
    $('#hobby-input').value = data.hobby || '';
  } else $('#owner-area').style.display='none';

  if(currentUser){
    const liked = Array.isArray(data.likedUserIds) && data.likedUserIds.includes(currentUser.uid);
    $('#heart-user').classList.toggle('liked', liked);
  }
}

$('#heart-user').addEventListener('click', async ()=>{
  if(!currentUser){ showToast('ログインが必要です'); return; }
  const uid = viewingUid;
  const ref = db.collection('users').doc(uid);
  $('#heart-user').classList.toggle('liked'); $('#heart-user').style.transform='scale(1.25)'; setTimeout(()=>$('#heart-user').style.transform='scale(1)',180);
  try{
    await db.runTransaction(async tr=>{
      const s = await tr.get(ref);
      if(!s.exists) return;
      let { likeCount=0, likedUserIds=[] } = s.data();
      if(likedUserIds.includes(currentUser.uid)){ likeCount--; likedUserIds = likedUserIds.filter(x=>x!==currentUser.uid); }
      else { likeCount++; likedUserIds.push(currentUser.uid); }
      tr.update(ref,{ likeCount, likedUserIds });
    });
  }catch(e){ console.error(e); showToast('操作に失敗しました'); }
});

$('#save-profile').addEventListener('click', async ()=>{
  if(!currentUser || currentUser.uid !== viewingUid) return;
  showLoading(true);
  try{
    let iconUrl=null;
    const file = $('#icon-input').files[0];
    if(file){ const ref = storage.ref().child(`icons/${currentUser.uid}/${Date.now()}_${file.name}`); await ref.put(file); iconUrl = await ref.getDownloadURL(); }
    const updates = { bio: $('#bio-input').value, fav: $('#fav-input').value, hobby: $('#hobby-input').value, lastLogin: firebase.firestore.FieldValue.serverTimestamp() };
    if(iconUrl) updates.iconUrl = iconUrl;
    await db.collection('users').doc(currentUser.uid).set(updates, { merge:true });
    showToast('保存しました');
  }catch(e){ console.error(e); showToast('保存失敗'); } finally{ showLoading(false); }
});

function loadRecent(uid){
  db.collection('posts').where('userId','==',uid).orderBy('createdAt','desc').limit(5).onSnapshot(snap=>{
    const el = $('#recent-posts'); el.innerHTML = '';
    if(snap.empty){ el.innerHTML = '<div class="muted">投稿はまだありません</div>'; return; }
    snap.forEach(d=>{ const p=d.data(); const row=document.createElement('div'); row.className='post'; row.innerHTML=`<div class="post-title" style="font-weight:600">${escapeHtml(p.title||'(無題)')}</div><div class="muted">${formatDate(p.createdAt)}</div>`; row.addEventListener('click', ()=> location.href=`post.html?id=${d.id}`); el.appendChild(row); });
  });
}
</script>
</body>
</html>
